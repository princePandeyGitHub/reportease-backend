#!/usr/bin/env node
import { Command } from 'commander';
import { scanProject } from "../src/scanner.js";
import { askProjectProblem } from "../src/userInput.js";
import { generatePrompt } from "../src/prompt.js";
import clipboardy from "clipboardy";

const program = new Command();

program
  .name("postmybuild")
  .description("Generate social media posts for your projects from the terminal")
  .version("0.1.0");

program
  .option("--linkedin", "Generate a LinkedIn post")
  .option("--x", "Generate a post for X (Twitter)")
  .option("--instagram", "Generate an Instagram caption");

program.parse(process.argv);

(async () => {
  const options = program.opts();

  const selectedPlatforms = Object.entries(options)
    .filter(([_, value]) => value === true)
    .map(([key]) => key);

  if (selectedPlatforms.length === 0) {
    console.error("‚ùå Please specify a platform:");
    console.error("   postmybuild --linkedin | --x | --instagram");
    process.exit(1);
  }

  if (selectedPlatforms.length > 1) {
    console.error("‚ùå Please choose only one platform at a time.");
    process.exit(1);
  }

  const platform = selectedPlatforms[0];

  console.log(`‚úî Platform selected: ${platform}`);
  console.log("üîç Scanning project...\n");

  const projectData = scanProject();

  console.log("üì¶ Project detected:");
  console.log(`   Name: ${projectData.name || "Unknown"}`);
  console.log(`   Description: ${projectData.description || "Not provided"}`);
  console.log(
    `   Tech stack: ${projectData.techStack.length
      ? projectData.techStack.slice(0, 5).join(", ")
      : "Not detected"
    }`
  );

  const problem = await askProjectProblem();

  console.log("\n‚úî Got it!");
  console.log(`   Problem: ${problem || "Not provided"}`);

  const prompt = generatePrompt({
    platform,
    projectData,
    problemStatement: problem,
  });

  clipboardy.writeSync(prompt);
  console.log("‚úÖ Prompt copied to clipboard! Paste it into your AI of choice.");

})();
